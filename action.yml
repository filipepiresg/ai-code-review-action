# ===============================================
# ü§ñ AI Code Review Action - Configura√ß√£o
# ===============================================
# Esta GitHub Action realiza revis√£o autom√°tica de c√≥digo usando IA
# Suporta OpenAI GPT-4/5 e Anthropic Claude 3.x
# Analisa arquivos modificados em PRs e publica feedback automaticamente

name: "AI Code Review Action"
description: "Executa revis√£o autom√°tica de c√≥digo com GPT-5 (ou ClaudeAI) e publica feedback no PR."
author: "Filipe Pires"
branding:
  icon: "check-circle"
  color: "blue"

inputs:
  # ===============================================
  # üîë CHAVES DE API (obrigat√≥rias)
  # ===============================================
  openai_api_key:
    description: |
      Chave da API da OpenAI para usar GPT-4/5.
      Configure em: Settings > Secrets > Actions > OPENAI_API_KEY
      Exemplo: sk-...
    required: false
    default: ""

  claude_api_key:
    description: |
      Chave da API da Anthropic Claude para usar Claude 3.x.
      Configure em: Settings > Secrets > Actions > CLAUDEAI_API_KEY
      Exemplo: sk-ant-...
    required: false
    default: ""

  # ===============================================
  # üîß CONFIGURA√á√ïES DO GITHUB
  # ===============================================
  github_token:
    description: |
      Token do GitHub para comentar no PR.
      Use o token padr√£o: secrets.GITHUB_TOKEN
      Permiss√µes necess√°rias: pull-requests: write
    required: true

  pr_number:
    description: |
      N√∫mero do Pull Request a ser analisado.
      Use: { github.event.pull_request.number }
    required: true

  repository:
    description: |
      Nome completo do reposit√≥rio no formato owner/repo.
      Use: { github.repository }
      Exemplo: filipepiresg/ai-code-review-action
    required: true

  # ===============================================
  # ‚öôÔ∏è CONFIGURA√á√ïES DE AN√ÅLISE
  # ===============================================
  analyze_limit:
    description: |
      N√∫mero m√°ximo de arquivos a analisar por PR.
      √ötil para PRs grandes com muitos arquivos modificados.
      Padr√£o: 10 arquivos
    required: false
    default: "10"

  model:
    description: |
      Modelo de IA a ser usado para an√°lise.
      OpenAI: gpt-4-mini, gpt-4, gpt-4-turbo, gpt-5
      Claude: claude-opus-4-1, claude-haiku-4-5, claude-sonnet-4-5
      Padr√£o: gpt-5
    required: false
    default: "gpt-5"

  # ===============================================
  # üö´ CONFIGURA√á√ïES DE IGNORE
  # ===============================================
  ignore_file_content:
    description: |
      Lista de padr√µes regex (um por linha) para ignorar arquivos/pastas.
      Exemplo:
      ^src/__tests__/
      ^node_modules/
      \.{test,spec}.{j,t}s?(x)$
      \.json$
    required: false
    default: ""

  ignore_file_path:
    description: |
      Caminho para arquivo de ignore (sintaxe similar ao .gitignore).
      Exemplo: .ai-review-ignore
      Formato: um padr√£o por linha, coment√°rios com #
    required: false
    default: ""

  guidelines_path:
    description: |
      Caminho para arquivo de diretrizes personalizadas do projeto.
      Este arquivo cont√©m as diretrizes espec√≠ficas que a IA deve seguir durante a an√°lise.
      Se n√£o especificado, usa o arquivo padr√£o: knowledge/ai-review-guidelines.md

      Exemplo de conte√∫do do arquivo:
      - Princ√≠pios de Clean Code, SOLID, KISS, DRY
      - Boas pr√°ticas de seguran√ßa
      - Formato de resposta desejado
      - Padr√µes espec√≠ficos do projeto

      Exemplos de caminho:
      - knowledge/ai-review-guidelines.md
      - docs/code-review-rules.md
      - .github/ai-guidelines.md
    required: false
    default: "knowledge/ai-review-guidelines.md"

# ===============================================
# üöÄ EXECU√á√ÉO DA ACTION
# ===============================================
runs:
  using: "composite" # Permite executar scripts em diferentes shells
  steps:
    # ===============================================
    # üì• PREPARA√á√ÉO DO AMBIENTE
    # ===============================================
    # Baixa o c√≥digo do reposit√≥rio para an√°lise
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Baixar cache de an√°lise da IA
      uses: actions/download-artifact@v4
      with:
        name: ai-review-cache-pr-${{ github.event.pull_request.number }}
        path: ${{ github.workspace }}/cache/
      continue-on-error: true # Se n√£o existir, ignora o erro

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', github.action_path)) }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Configura ambiente Python para execu√ß√£o dos scripts
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11" # Vers√£o m√≠nima necess√°ria para as depend√™ncias

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r ${{ github.action_path }}/requirements.txt
        # Instala depend√™ncias necess√°rias:
        # - openai: Cliente para API OpenAI
        # - PyGithub: Cliente para API GitHub
        # - pathspec: Para valida√ß√£o de arquivos

    # ===============================================
    # ü§ñ EXECU√á√ÉO DA AN√ÅLISE DE C√ìDIGO
    # ===============================================
    - name: Run AI Review script
      shell: bash
      env:
        # Chaves de API das LLMs
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        CLAUDE_API_KEY: ${{ inputs.claude_api_key }}

        # Configura√ß√µes do GitHub
        GITHUB_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ inputs.repository }}
        GITHUB_PR_NUMBER: ${{ inputs.pr_number }}

        # Configura√ß√µes de an√°lise
        MODEL_NAME: ${{ inputs.model }}
        ANALYZE_LIMIT: ${{ inputs.analyze_limit }}
        IGNORE_FILE_CONTENT: ${{ inputs.ignore_file_content }}
        IGNORE_FILE_PATH: ${{ inputs.ignore_file_path }}
        GUIDELINES_PATH: ${{ inputs.guidelines_path }}
        CACHE_DIR: cache

      run: |
        python "${{ github.action_path }}/scripts/ai_review_pr.py"
        # Executa o script principal de an√°lise de c√≥digo

    - name: Salvar cache de an√°lise da IA
      uses: actions/upload-artifact@v4
      with:
        name: ai-review-cache-pr-${{ github.event.pull_request.number }}
        path: ${{ github.workspace }}/cache/
